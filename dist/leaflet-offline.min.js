"use strict";!function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(f){f.TileLayer.Offline=f.TileLayer.extend({initialize:function(e,t,o){this._url=e,this._tilesDb=t,(o=f.Util.setOptions(this,o)).detectRetina&&f.Browser.retina&&0<o.maxZoom&&(o.tileSize=Math.floor(o.tileSize/2),o.zoomReverse?(o.zoomOffset--,o.minZoom++):(o.zoomOffset++,o.maxZoom--),o.minZoom=Math.max(0,o.minZoom)),"string"==typeof o.subdomains&&(o.subdomains=o.subdomains.split("")),f.Browser.android||this.on("tileunload",this._onTileRemove)},createTile:function(e,t){var o=document.createElement("img");return f.DomEvent.on(o,"load",f.bind(this._tileOnLoad,this,t,o)),f.DomEvent.on(o,"error",f.bind(this._tileOnError,this,t,o)),this.options.crossOrigin&&(o.crossOrigin=""),o.alt="",o.setAttribute("role","presentation"),this.getTileUrl(e).then(function(e){o.src=e}).catch(function(e){throw e}),o},getTileUrl:function(e){var t=f.TileLayer.prototype.getTileUrl.call(this,e),o=this._getStorageKey(t);return this._tilesDb.getItem(o).then(function(e){return e&&"object"==typeof e?URL.createObjectURL(e):t},function(e){return t}).catch(function(e){throw e})},getTileUrls:function(e,t){var o=[],i=this._url;this.setUrl(this._url.replace("{z}",t),!0);for(var n=f.bounds(e.min.divideBy(this.getTileSize().x).floor(),e.max.divideBy(this.getTileSize().x).floor()),r=n.min.x;r<=n.max.x;r++)for(var l=n.min.y;l<=n.max.y;l++){var s=new f.Point(r,l),a=f.TileLayer.prototype.getTileUrl.call(this,s);o.push({key:this._getStorageKey(a),url:a})}return this.setUrl(i,!0),o},_getStorageKey:function(e){var t=null;if(e.indexOf("{s}")){var o=new RegExp("/("+this.options.subdomains.join("|")+").");t=e.replace(o,"/"+this.options.subdomains[0]+".")}return t||e}}),f.tileLayer.offline=function(e,t,o){return new f.TileLayer.Offline(e,t,o)}},window),function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(s){s.Control.Offline=s.Control.extend({options:{position:"topleft",saveButtonHtml:"S",saveButtonTitle:"Save tiles",removeButtonHtml:"R",removeButtonTitle:"Remove tiles",minZoom:0,maxZoom:19,confirmSavingCallback:null,confirmRemovalCallback:null},initialize:function(e,t,o){this._baseLayer=e,this._tilesDb=t,s.Util.setOptions(this,o)},onAdd:function(e){var t=s.DomUtil.create("div","leaflet-control-offline leaflet-bar");return this._createButton(this.options.saveButtonHtml,this.options.saveButtonTitle,"save-tiles-button",t,this._saveTiles),this.options.removeButtonHtml&&this.options.removeButtonTitle&&this._createButton(this.options.removeButtonHtml,this.options.removeButtonTitle,"remove-tiles-button",t,this._removeTiles),t},_createButton:function(e,t,o,i,n){var r=s.DomUtil.create("a",o,i);return r.innerHTML=e,r.href="#",r.title=t,s.DomEvent.disableClickPropagation(r),s.DomEvent.on(r,"click",s.DomEvent.stop),s.DomEvent.on(r,"click",n,this),s.DomEvent.on(r,"click",this._refocusOnMap,this),r},_saveTiles:function(){var o=this,i=null,n=[],r=[],l=this._map.getBounds();if(this.options.minZoom<this._baseLayer.options.minZoom)return o._baseLayer.fire("offline:below-min-zoom-error"),void console.error("Can not save tiles below base layer minimum zoom level.");var e=function(){for(var e=o.options.minZoom;e<=o.options.maxZoom;e++)n.push(e);for(var t=0;t<n.length;t++)i=s.bounds(o._map.project(l.getNorthWest(),n[t]),o._map.project(l.getSouthEast(),n[t])),r=r.concat(o._baseLayer.getTileUrls(i,n[t]));o._baseLayer.fire("offline:save-start",{nTilesToSave:r.length}),o._tilesDb.saveTiles(r).then(function(){o._baseLayer.fire("offline:save-end")}).catch(function(e){o._baseLayer.fire("offline:save-error",{error:e})})};this.options.confirmSavingCallback?this.options.confirmSavingCallback.call(this,r.length,e):e()},_removeTiles:function(){var t=this,e=function(){t._baseLayer.fire("offline:remove-start"),t._tilesDb.clear().then(function(){t._baseLayer.fire("offline:remove-end")}).catch(function(e){t._baseLayer.fire("offline:remove-error",{error:e})})};t.options.confirmRemovalCallback?t.options.confirmRemovalCallback(e):e()}}),s.control.offline=function(e,t,o){return new s.Control.Offline(e,t,o)}},window),function(e){"function"==typeof define&&define.amd?define(["./TileLayer.Offline","./Control.Offline"],e):"object"==typeof exports&&module.exports&&(module.exports=(require("./TileLayer.Offline"),void require("./Control.Offline")))}(function(e,t){});